name: Node.js CI
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HUSKY: 0

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Lint
        run: npm run lint

  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Type check
        run: npm run typecheck --if-present

  vitest:
    name: Vitest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Run vitest
        run: npm run test

  e2e:
    name: Playwright E2E
    runs-on: ubuntu-latest
    environment: CI
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          CI: true
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }} \
          DISCORD_PUBLIC_KEY: ${{ secrets.DISCORD_PUBLIC_KEY }} \
          DISCORD_APP_ID: ${{ secrets.DISCORD_APP_ID }} \
          DISCORD_SECRET: ${{ secrets.DISCORD_SECRET }} \
          DISCORD_HASH: ${{ secrets.DISCORD_HASH }} \
          DISCORD_TEST_GUILD: ${{ secrets.DISCORD_TEST_GUILD }} \
          SENTRY_INGEST: ${{ secrets.SENTRY_INGEST }} \
          SENTRY_RELEASES: ${{ secrets.SENTRY_RELEASES }} \
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          VITE_PUBLIC_POSTHOG_KEY: ${{ secrets.VITE_PUBLIC_POSTHOG_KEY }} \
          VITE_PUBLIC_POSTHOG_HOST: ${{ secrets.VITE_PUBLIC_POSTHOG_HOST }} \
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Generate test summary
        if: always()
        run: |
          echo "## üé≠ Playwright E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f playwright-report/index.html ]; then
            # Extract test counts from the HTML report
            TOTAL=$(grep -o 'passed.*failed.*skipped' playwright-report/index.html | head -1 || echo "Results available in artifacts")
            echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
            echo "**Test Suite**: Payment Flow E2E" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üìä Test artifacts available below" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Test report not generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Report (playwright-report/)" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "- Video recordings" >> $GITHUB_STEP_SUMMARY

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Deploy test report to GitHub Pages
        if: always() && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      - name: Comment PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = '${{ github.run_id }}';
            const runNumber = '${{ github.run_number }}';
            const status = '${{ job.status }}';
            const reportUrl = `https://reactiflux.github.io/mod-bot/reports/${runNumber}`;

            let statusEmoji = '‚úÖ';
            if (status === 'failure') statusEmoji = '‚ùå';
            else if (status === 'cancelled') statusEmoji = '‚ö†Ô∏è';

            const comment = `## ${statusEmoji} Playwright E2E Test Results

            **Status**: ${status}
            **Test Suite**: Payment Flow (11 tests)
            **Run**: [#${runNumber}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${runId})

            ### üìä Reports & Artifacts

            - üåê [**View HTML Report**](${reportUrl}) *(available after merge to main)*
            - üì¶ [Download Artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${runId})

            <details>
            <summary>Test Coverage</summary>

            - Stripe checkout flow (complete integration)
            - Onboarding flows (free/pro guilds)
            - Upgrade page display
            - Payment success/cancel pages
            - Error handling
            - Database isolation
            </details>

            <details>
            <summary>Available Artifacts</summary>

            - HTML test report with screenshots
            - Video recordings of test execution
            - Test result JSON
            - Screenshots (on failure)
            </details>
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Playwright E2E Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag Build
        uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}
          # Only tag with latest if we're on main
          tags: |
            type=ref,event=pr
            type=ref,event=branch
            type=sha
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Build and push Docker images
        uses: docker/build-push-action@v6
        with:
          push: ${{github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/actions'}}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deployment:
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/feature/actions'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout to branch
        uses: actions/checkout@v4

      - name: Tag Build
        uses: docker/metadata-action@v5
        id: meta
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha

      - name: Create build context for k8s deployment
        # There should only be 1 tag, so 'join' will just produce a simple string
        run: |
          touch k8s-context
          echo IMAGE=${{ join(steps.meta.outputs.tags, '') }} > k8s-context
          cat k8s-context

      - name: Set up kubectl
        uses: matootie/dokube@v1.4.1
        with:
          personalAccessToken: ${{ secrets.DIGITALOCEAN_TOKEN }}
          clusterName: k8s-rf

      - name: Deploy app
        run: |
          kubectl diff -k . || echo \n
          kubectl delete secret modbot-env || echo \n
          kubectl create secret generic modbot-env \
            --from-literal=SESSION_SECRET=${{ secrets.SESSION_SECRET }} \
            --from-literal=DISCORD_PUBLIC_KEY=${{ secrets.DISCORD_PUBLIC_KEY }} \
            --from-literal=DISCORD_APP_ID=${{ secrets.DISCORD_APP_ID }} \
            --from-literal=DISCORD_SECRET=${{ secrets.DISCORD_SECRET }} \
            --from-literal=DISCORD_HASH=${{ secrets.DISCORD_HASH }} \
            --from-literal=DISCORD_TEST_GUILD=${{ secrets.DISCORD_TEST_GUILD }} \
            --from-literal=SENTRY_INGEST=${{ secrets.SENTRY_INGEST }} \
            --from-literal=SENTRY_RELEASES=${{ secrets.SENTRY_RELEASES }} \
            --from-literal=STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }} \
            --from-literal=STRIPE_PUBLISHABLE_KEY=${{ secrets.STRIPE_PUBLISHABLE_KEY }} \
            --from-literal=VITE_PUBLIC_POSTHOG_KEY=${{ secrets.VITE_PUBLIC_POSTHOG_KEY }} \
            --from-literal=VITE_PUBLIC_POSTHOG_HOST=${{ secrets.VITE_PUBLIC_POSTHOG_HOST }} \
            --from-literal=DATABASE_URL=${{ secrets.DATABASE_URL }}
          kubectl apply -k .

      - name: Set Sentry release
        run: |
          curl ${{secrets.SENTRY_RELEASES}} \
            -X POST \
            -H 'Content-Type: application/json' \
            -d '{"version": "${{github.sha}}"}'
