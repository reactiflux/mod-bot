name: CI
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  HUSKY: 0

on:
  push:
    branches-ignore:
      - "main"

jobs:
  lint:
    name: ESLint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Lint
        run: npm run lint

  typecheck:
    name: TypeScript
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Type check
        run: npm run typecheck --if-present

  vitest:
    name: Vitest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Run vitest
        run: npm run test

  e2e:
    name: Playwright E2E
    timeout-minutes: 5
    runs-on: ubuntu-latest
    environment: CI
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - run: npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        run: npm run test:e2e
        env:
          NODE_ENV:
          CI: true
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          DISCORD_PUBLIC_KEY: ${{ secrets.DISCORD_PUBLIC_KEY }}
          DISCORD_APP_ID: ${{ secrets.DISCORD_APP_ID }}
          DISCORD_SECRET: ${{ secrets.DISCORD_SECRET }}
          DISCORD_HASH: ${{ secrets.DISCORD_HASH }}
          DISCORD_TEST_GUILD: ${{ secrets.DISCORD_TEST_GUILD }}
          SENTRY_INGEST: ${{ secrets.SENTRY_INGEST }}
          SENTRY_RELEASES: ${{ secrets.SENTRY_RELEASES }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          VITE_PUBLIC_POSTHOG_KEY: ${{ secrets.VITE_PUBLIC_POSTHOG_KEY }}
          VITE_PUBLIC_POSTHOG_HOST: ${{ secrets.VITE_PUBLIC_POSTHOG_HOST }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Generate test summary
        run: |
          echo "## ðŸŽ­ Playwright E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f playwright-report/index.html ]; then
            # Extract test counts from the HTML report
            TOTAL=$(grep -o 'passed.*failed.*skipped' playwright-report/index.html | head -1 || echo "Results available in artifacts")
            echo "**Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
            echo "**Test Suite**: Payment Flow E2E" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š Test artifacts available below" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Test report not generated" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Report (playwright-report/)" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots (on failure)" >> $GITHUB_STEP_SUMMARY
          echo "- Video recordings" >> $GITHUB_STEP_SUMMARY

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30

      - name: Deploy test report to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./playwright-report
          destination_dir: reports/${{ github.run_number }}
          keep_files: true

      - name: Comment PR with test results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const runId = '${{ github.run_id }}';
            const runNumber = '${{ github.run_number }}';
            const reportUrl = `https://reactiflux.github.io/mod-bot/reports/${runNumber}`;

            // Find PR associated with this push
            const branch = context.ref.replace('refs/heads/', '');
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              state: 'open'
            });

            if (prs.length === 0) {
              console.log(`No open PR found for branch ${branch}, skipping comment`);
              return;
            }

            // Parse test results
            let testRows = [];
            let stats = { passed: 0, failed: 0, flaky: 0, skipped: 0 };

            try {
              const results = JSON.parse(fs.readFileSync('test-results/results.json', 'utf8'));

              const processSpecs = (suites) => {
                for (const suite of suites) {
                  for (const spec of suite.specs || []) {
                    for (const test of spec.tests || []) {
                      const status = test.status;
                      if (status === 'expected') stats.passed++;
                      else if (status === 'unexpected') stats.failed++;
                      else if (status === 'flaky') stats.flaky++;
                      else if (status === 'skipped') stats.skipped++;

                      // Get duration from the last result
                      const lastResult = test.results?.[test.results.length - 1];
                      const duration = lastResult?.duration || 0;
                      const durationStr = duration >= 1000
                        ? `${(duration / 1000).toFixed(1)}s`
                        : `${duration}ms`;

                      // Check for retries
                      const retryCount = test.results?.length - 1 || 0;
                      const retryInfo = retryCount > 0 ? ` (${retryCount} ${retryCount === 1 ? 'retry' : 'retries'})` : '';

                      let emoji;
                      if (status === 'expected') emoji = 'âœ…';
                      else if (status === 'flaky') emoji = 'âš ï¸';
                      else if (status === 'unexpected') emoji = 'âŒ';
                      else emoji = 'â­ï¸';

                      const testLink = spec.id
                        ? `[${spec.title}](${reportUrl}#?testId=${spec.id})`
                        : spec.title;

                      testRows.push(`| ${emoji} | ${testLink}${retryInfo} | ${durationStr} |`);
                    }
                  }

                  // Recurse into child suites
                  if (suite.suites) {
                    processSpecs(suite.suites);
                  }
                }
              };

              processSpecs(results.suites || []);
            } catch (e) {
              console.log('Could not parse test results:', e.message);
            }

            const total = stats.passed + stats.failed + stats.flaky + stats.skipped;
            const statusEmoji = stats.failed > 0 ? 'âŒ' : 'âœ…';
            const statusText = stats.failed > 0 ? 'Failed' : stats.flaky > 0 ? 'Flaky' : 'Passed';

            // Build stats line
            let statsParts = [];
            if (stats.passed > 0) statsParts.push(`**${stats.passed}** passed`);
            if (stats.flaky > 0) statsParts.push(`**${stats.flaky}** flaky`);
            if (stats.failed > 0) statsParts.push(`**${stats.failed}** failed`);
            if (stats.skipped > 0) statsParts.push(`**${stats.skipped}** skipped`);

            let comment = [
              `## ${statusEmoji} E2E Tests ${statusText}`,
              '',
              statsParts.join(' Â· '),
              '',
              `[View Report](${reportUrl}) Â· [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${runId})`,
              '',
              '|  | Test | Duration |',
              '|--------|------|----------|',
              ...testRows
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: prs[0].number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
