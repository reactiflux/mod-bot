# Developer Experience Evaluation - 2025-10-27

## Executive Summary

Evaluated the development workflow by starting the server, making a simple code change, and observing hot reload behavior. **Critical DX issue identified**: file changes in `./app` trigger a full server restart (including Discord bot reconnection) rather than using Vite's HMR, resulting in 6-8 second feedback loops and manual browser refreshes.

## Test Methodology

1. Started development server with `npm run dev`
2. Opened browser to `localhost:3000` via Playwright
3. Captured initial state (logs, screenshots, console)
4. Modified `app/routes/index.tsx` (added "Testing hot reload!" text)
5. Monitored server logs and browser behavior during reload
6. Documented findings

## Environment Details

- **Server**: Express + Vite dev server
- **Framework**: React Router v7 (formerly Remix)
- **Database**: SQLite3 with Kysely ORM
- **CSS**: Tailwind with watch mode
- **External Services**: Discord bot (discord.js), PostHog analytics

## Findings

### 🔴 Critical Issues

#### 1. Full Server Restart on Frontend Changes

**Symptom**: Changing `app/routes/index.tsx` triggers complete server restart

**Root Cause**: `package.json` script configuration uses Node's `--watch` on entire `./app` directory

```json
"dev:bot": "node --watch --watch-path='./app' index.dev.js"
```

**Why it exists**: Previous attempt to use only Vite HMR resulted in stale Discord bot code running without proper reloads. The `--watch` approach was implemented as a workaround to ensure bot code actually reloads.

**Trade-off**: Guarantees code freshness but sacrifices developer experience

**Impact**:

- **Slow feedback loop**: 6-8 seconds per change (even for pure UI work)
- **Discord reconnection**: Bot disconnects/reconnects on every file save (spam in Discord audit logs)
- **Browser loses connection**: Page shows "Cannot GET /" error until manual refresh
- **Lost state**: All server state (including Discord gateway connection) is destroyed
- **Cognitive overhead**: Developer must mentally track if they're changing bot vs. web code

**Evidence from logs**:

```
3:30:54 PM [vite] hmr update /app/routes/index.tsx
Restarting 'index.dev.js'
Restarting 'index.dev.js'
Starting development server
INI Now listening on port 3000
...
Connecting to database at ./mod-bot.sqlite3
{"level":"info","service":"Gateway","message":"Initializing Discord gateway"}
{"level":"info","service":"Client","message":"Starting Discord client login"}
{"level":"info","service":"Client","message":"Discord client login successful"}
```

**Browser console during restart**:

```
[vite] hot updated: /app/routes/index.tsx
[vite] server connection lost. Polling for restart...
Failed to load resource: the server responded with a status of 404 (Not Found)
```

#### 2. Conflicting Hot Reload Systems

Vite detects the file change and attempts HMR, but Node's `--watch` immediately restarts the server, killing the Vite connection mid-update.

**Expected behavior**: Vite HMR should update React components in-browser without server restart

**Actual behavior**: Vite starts HMR → Node restarts server → Browser connection lost → Manual refresh required

### ⚠️ Moderate Issues

#### 3. Console Noise on Every Startup

Every server restart shows these warnings:

```
Browserslist: caniuse-lite is outdated. Please run:
  npx update-browserslist-db@latest

Invalid Sentry Dsn: example.com

The "__session" cookie is not signed, but session cookies should be signed
to prevent tampering on the client before they are sent back to the server.

Error: No route matches URL "/.well-known/appspecific/com.chrome.devtools.json"
```

**Impact**: Important errors get buried in noise, making debugging harder

#### 4. Startup Sequence Runs on Every File Change

Because of full server restart, the entire initialization sequence runs:

1. Database migration check
2. Seed check
3. Type generation (`kysely-codegen`)
4. Discord gateway connection
5. Command deployment to guilds

**Total startup time**: ~6-8 seconds

This makes sense for initial startup, but shouldn't happen on frontend file changes.

#### 5. Two Parallel Dev Processes Running

Found evidence of two `npm run dev` processes running simultaneously (original issue with port conflict). This suggests previous dev session wasn't cleaned up properly.

### ✅ Positive Aspects

#### Working Well

1. **Tailwind watch mode**: CSS changes compile quickly in parallel
2. **Database migrations**: Automated and reliable
3. **Type generation**: `kysely-codegen` generates TypeScript types automatically
4. **PostHog integration**: Analytics working without errors
5. **Page rendering**: Clean, professional UI with animated emoji background
6. **Vite dev server**: Fast module resolution when it's not being killed
7. **Structured logging**: JSON logs from Discord gateway are well-formatted

#### Initial Page Load

- **Clean console**: Only React DevTools suggestion and Vite connection messages
- **Fast initial render**: Page loads quickly
- **No hydration errors**: SSR working correctly
- **Network requests**: All resources load successfully (except expected 404 for Chrome DevTools)

## Recommendations

### High Priority

#### 1. Fix Vite HMR for Discord Bot Code

**Root problem**: Vite HMR doesn't properly reload Discord bot modules, causing stale code

**Current workaround**: Use `node --watch` on entire `./app` directory to force restarts

**Better solution**: Investigate why Vite HMR fails for bot code and fix it properly

**Possible causes**:

1. **Singleton Discord client**: Gateway connection might need explicit disposal/recreation on HMR
2. **Module side effects**: Discord bot initialization in `app/discord/gateway.ts` runs at import time
3. **Event listeners**: Old event handlers not cleaned up before new ones attached
4. **Vite SSR module cache**: Bot modules might need explicit cache invalidation

**Investigation steps**:

1. Check if Discord gateway code uses HMR disposal callbacks (`import.meta.hot?.dispose()`)
2. Review module initialization pattern in `app/discord/gateway.ts`
3. Test if bot code HMR works when gateway is NOT initialized
4. Add HMR boundaries in bot modules

**Example fix pattern**:

```ts
// app/discord/gateway.ts
let client: Client | null = null;

export default function initializeGateway() {
  if (client) {
    console.log("Gateway already initialized");
    return client;
  }

  client = new Client({...});

  // HMR disposal
  if (import.meta.hot) {
    import.meta.hot.dispose(() => {
      console.log("Disposing Discord gateway for HMR");
      client?.destroy();
      client = null;
    });
  }

  return client;
}
```

#### 2. Interim Solution: Separate Dev Modes

**Until HMR is fixed**, provide explicit dev modes for different workflows:

Current:

```json
{
  "dev": "npm run dev:init; run-p dev:css dev:bot",
  "dev-client": "npm run dev:init; run-p dev:css dev:web",
  "dev:bot": "node --watch --watch-path='./app' index.dev.js"
}
```

Proposed addition:

```json
{
  "dev": "npm run dev:init; run-p dev:css dev:bot-watch",
  "dev:web-only": "npm run dev:init; run-p dev:css dev:web",
  "dev:web": "node index.dev.js",
  "dev:bot-watch": "node --watch --watch-path='./app/discord' --watch-path='./app/commands' index.dev.js"
}
```

**Benefits**:

- `dev:web-only`: UI work without bot (fast Vite HMR, no Discord spam)
- `dev`: Full stack with bot restarting only on Discord file changes
- Clear separation makes the trade-off explicit
- Better than current `dev-client` which still has issues

**Add to README.md**:

```md
## Development Modes

- `npm run dev:web-only` - Web UI development only (fast HMR, no Discord bot)
- `npm run dev` - Full stack development (slower, includes Discord bot)
- Use `dev:web-only` for UI work, switch to `dev` when testing bot interactions
```

#### 3. Add `.env.example` and Document Config

Current setup has warnings about invalid Sentry DSN and PostHog config. Need:

- `.env.example` file showing required variables
- Documentation for local development (dev vs production configs)
- Option to disable Sentry/PostHog in local dev

### Medium Priority

#### 4. Clean Up Console Warnings

- Run `npx update-browserslist-db@latest` and commit
- Add route or middleware to suppress Chrome DevTools 404s
- Document session cookie signing requirement or disable in dev
- Make Sentry initialization conditional on valid DSN

#### 5. Skip Unnecessary Init Steps in Dev

`dev:init` runs migrations and type generation every time. Consider:

- Only run migrations if schema changed
- Only run type generation if migrations ran
- Cache check to skip when unnecessary

#### 6. Add Development Error Overlay

Vite has built-in error overlay. Ensure it's enabled for better DX:

```ts
// vite.config.ts
export default {
  server: {
    hmr: {
      overlay: true,
    },
  },
};
```

### Low Priority

#### 7. Add Dev Server Health Check

Create a `/api/health` endpoint that shows:

- Server status
- Database connection
- Discord gateway status
- Last HMR update time

Useful for debugging when things go wrong.

#### 8. Graceful Shutdown Handler

When killing dev server, ensure:

- Discord bot properly disconnects
- Database connections close
- No orphaned processes

## Testing the Fixes

To validate improvements:

1. Start `npm run dev-web-only`
2. Make frontend change
3. Verify:
   - Change appears in <3 seconds
   - No server restart in logs
   - Browser auto-updates (no refresh needed)
   - No Discord reconnection

## Architecture Notes

### Current Setup

```
npm run dev
├── dev:init (sequential)
│   ├── migrations
│   ├── seeds
│   └── type generation
└── run-p (parallel)
    ├── dev:css (Tailwind watch)
    └── dev:bot (Node --watch on ./app)
        ├── Express server
        ├── Vite dev server (HMR)
        └── Discord gateway
```

### Proposed Setup

```
npm run dev-web-only (for frontend work)
├── dev:init
└── run-p
    ├── dev:css
    └── dev:web (no --watch, relies on Vite HMR)
        ├── Express server
        └── Vite dev server (HMR) ✅

npm run dev (for full-stack work)
├── dev:init
└── run-p
    ├── dev:css
    ├── dev:web
    └── dev:bot-watch (--watch only on Discord files)
        └── Discord gateway (restarts only on bot changes)
```

## Conclusion

The project has a solid foundation with good tooling choices (Vite, TypeScript, Kysely), but the development workflow is significantly hampered by the `--watch` configuration that restarts the entire server on frontend changes. This is a common pitfall when combining Node.js applications with Vite-powered frontends.

**Recommended immediate action**: Use `npm run dev-client` for web development (if it works correctly), or implement the separate dev mode as outlined above.

**Estimated impact of fixes**: Reduce feedback loop from 6-8 seconds to <1 second for frontend changes, dramatically improving development velocity.
